#!/usr/bin/env bash
#
# Install core essentials first (including Alfred).
#

set -e
cd "$(dirname "$0")"/..

echo "› homebrew/install.sh"
./homebrew/install.sh

# Ensure brew is available in this session (fresh Homebrew install)
if ! command -v brew >/dev/null 2>&1; then
  if [ -x /opt/homebrew/bin/brew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x /usr/local/bin/brew ]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
fi

echo "› brew bundle (core)"
brew bundle --file ./Brewfile.core

# GitHub auth (enables passwordless git push via SSH)
if [ "$(uname -s)" == "Darwin" ]; then
  echo "› github/install.sh"
  ./github/install.sh || true
fi

# Git user config (name/email)
echo "› git/install.sh"
./git/install.sh || true

# Apply macOS settings after pam-reattach is installed
if [ "$(uname -s)" == "Darwin" ]; then
  echo "› macos/set-defaults.sh"
  ./macos/set-defaults.sh
fi

# Alfred setup (hotkey + prefs link)
if [ "$(uname -s)" == "Darwin" ]; then
  echo "› alfred/install.sh"
  ./alfred/install.sh
fi

if [ "$(uname -s)" == "Darwin" ]; then
  echo "› homebrew/autoupdate.sh"
  ./homebrew/autoupdate.sh || true
fi

echo ""
echo "Core setup done."
echo "Next: run full install with: cd ~/dotfiles && brew bundle"

